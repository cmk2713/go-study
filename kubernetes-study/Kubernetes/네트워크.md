# 네트워크

## Pods 네트워크

> 노드 내부의 네트워크 흐름 설명
> 

### Pod 내 컨테이너 1개

![Untitled](%E1%84%82%E1%85%A6%E1%84%90%E1%85%B3%E1%84%8B%E1%85%AF%E1%84%8F%E1%85%B3/Untitled.png)

**eth0**(물리적 네트워크 인터페이스)

▼

**cbr0**(브릿지) ⇒ 쿠버네티스는 도커 표준 bridge를 사용하지 않고 자체 bridge(custom bridge)를 사용

▼

**veth0**(컨테이너의 가상 네트워크 인터페이스)

**cbr0** 브릿지와 **veth0**는 같은 네트워크로 묶여 있으며

**cbr0** 브릿지는 **veth0**의 게이트웨이(다른 네트워크로 들어가는 입구) 역할을 함

### Pod 내 컨테이너 2개 이상

![Untitled](%E1%84%82%E1%85%A6%E1%84%90%E1%85%B3%E1%84%8B%E1%85%AF%E1%84%8F%E1%85%B3/Untitled%201.png)

**x** (veth을 새로 생성하지 않음)

![Untitled](%E1%84%82%E1%85%A6%E1%84%90%E1%85%B3%E1%84%8B%E1%85%AF%E1%84%8F%E1%85%B3/Untitled%202.png)

**o** (기존의 veth 인터페이스를 이용해 함께 사용)

⇒ 1개의 Pod 마다 가지는 Pause 컨테이너 때문

Pause 컨테이너는 Pod 내 컨테이너들에게 network 네임스페이스를 공유

⇒ 한개의 IP 사용

따라서 컨테이너 끼리는 localhost로 통신이 가능

but, 같은 포트 사용 불가

### 멀티 노드

![Untitled](%E1%84%82%E1%85%A6%E1%84%90%E1%85%B3%E1%84%8B%E1%85%AF%E1%84%8F%E1%85%B3/Untitled%203.png)

위와 같이 두 노드 안의 브릿지가 같은 주소를 할당받은 경우, 해당 ip로 요청이 왔을 때, 어떤 노드의 파드로 패킷이 가야하는 지 알 수 없는 문제 발생

이러한 문제를 해결하기 위해 쿠버네티스는 CNI라는 네트워크 인터페이스를 추가적으로 설치

## CNI

- 외부 라우터에 각 호스트 사이 라우팅을 정의
- 오버레이 네트워크 구성해 각 노드별로 서브넷을 나눠 할당
    
    ⇒ 실제 노드 간 네트워크 위에 별도로 가상 네트워크를 구성
    

![Untitled](%E1%84%82%E1%85%A6%E1%84%90%E1%85%B3%E1%84%8B%E1%85%AF%E1%84%8F%E1%85%B3/Untitled%204.png)

## Service 네트워크

Pod는 일시적인 존재이며 Pod가 새로 생성되고 소멸됨에 따라 Pod의 ip는 변경될 수 있음

이것의 해결책으로 Pod 앞단에 리버스 프록시를 위치시키는 방법 사용.

이것을 수행해주는 추상적인 리소스가 **Service**

### Service

selector를 통해 선택한 각 포드로 트래픽을 포워딩해주는 프록시 역할